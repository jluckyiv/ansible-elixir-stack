---
- name: "install asdf"
  remote_user: "{{deployer}}"
  git:
    repo: "https://github.com/asdf-vm/asdf.git"
    dest: "~/.asdf"
    version: "v0.2.1"
    update: yes

- name: "source asdf in bashrc"
  remote_user: "{{deployer}}"
  lineinfile:
    dest: "~/.bashrc"
    create: yes
    line: ". $HOME/.asdf/asdf.sh"

- name: "asdf completions in bashrc"
  remote_user: "{{deployer}}"
  lineinfile:
    dest: "~/.bashrc"
    create: yes
    line: ". $HOME/.asdf/completions/asdf.bash"

# - name: "remove asdf plugins"
#   remote_user: "{{deployer}}"
#   command: "bash -lc 'asdf plugin-remove {{item}}'"
#   with_items:
#     - nodejs
#     - erlang
#     - elixir

- name: register erlang plugin
  command: "bash -lc 'asdf plugin-list | grep erlang'"
  register: erlang_plugin

- name: "add erlang plugin"
  debug: msg="erlang_plugin = {{ erlang_plugin }}"
  when: erlang_plugin != "erlang"
  remote_user: "{{deployer}}"
  command: "bash -lc 'asdf plugin-add erlang https://github.com/asdf-vm/asdf-erlang.git'"

- name: register elixir plugin
  command: "bash -lc 'asdf plugin-list | grep elixir'"
  register: elixir_plugin

- name: "add elixir plugin"
  when: elixir_plugin != "elixir"
  remote_user: "{{deployer}}"
  command: "bash -lc 'asdf plugin-add elixir https://github.com/asdf-vm/asdf-elixir.git'"

- name: register nodejs plugin
  command: "bash -lc 'asdf plugin-list | grep nodejs'"
  register: nodejs_plugin

- name: "add nodejs plugin"
  when: nodejs_plugin != "nodejs"
  remote_user: "{{deployer}}"
  command: "bash -lc 'asdf plugin-add nodejs https://github.com/asdf-vm/asdf-nodejs.git'"

- name: "add nodejs keys to keyring"
  remote_user: "{{deployer}}"
  command: "bash -lc 'bash ~/.asdf/plugins/nodejs/bin/import-release-team-keyring'"

# - name: "add elm plugin"
#   remote_user: "{{deployer}}"
#   command: "bash -lc 'asdf plugin-add elm https://github.com/vic/asdf-elm.git'"
